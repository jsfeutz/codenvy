# ###################################
# This file is generated by puppet
# PLEASE DON'T MODIFY BY HAND
# ###################################
version: '2'
services:

########################
# RSYSLOG
########################
  rsyslog:
    image: <%= ENV["IMAGE_RSYSLOG"] %>
    volumes:
      - '<%= scope.lookupvar('compose::codenvy_folder') -%>/config/rsyslog/rsyslog.conf:/etc/rsyslog.conf'
      - '<%= scope.lookupvar('compose::codenvy_folder') -%>/config/rsyslog/haproxy.conf:/etc/rsyslog.d/haproxy.conf'
      - '<%= scope.lookupvar('compose::codenvy_folder') -%>/config/rsyslog/registry.conf:/etc/rsyslog.d/registry.conf'
      - '<%= scope.lookupvar('compose::codenvy_folder') -%>/config/rsyslog/swarm.conf:/etc/rsyslog.d/swarm.conf'
      - '<%= scope.lookupvar('compose::codenvy_folder') -%>/logs/haproxy/:/var/log/haproxy'
      - '<%= scope.lookupvar('compose::codenvy_folder') -%>/logs/swarm/:/var/log/swarm'
      - '<%= scope.lookupvar('compose::codenvy_folder') -%>/logs/registry/:/var/log/registry'
    ports:
      - '5140:514'
    ulimits:
      nproc: 163840
      nofile:
        soft: 163840
        hard: 163840
    restart: always

########################
# HAPROXY
########################
  haproxy:
    image: <%= ENV["IMAGE_HAPROXY"] %>
    volumes:
<% if scope.lookupvar('codenvy::host_protocol') == 'https' -%>
      - '<%= scope.lookupvar('compose::path_to_haproxy_ssl_certificate') -%>:/etc/haproxy/cert.pem'
<% end -%>
      - '<%= scope.lookupvar('compose::codenvy_folder') -%>/config/haproxy/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg'
      - '<%= scope.lookupvar('compose::codenvy_folder') -%>/config/haproxy/maintenance.html:/etc/haproxy/maintenance.html'
    ports:
      - '80:80'
      - '443:443'
    links:
      - 'nginx:codenvy-nginx'
      - 'rsyslog:codenvy-rsyslog'
    ulimits:
      nproc: 163840
      nofile:
        soft: 163840
        hard: 163840
    restart: always

########################
# NGINX
########################
  nginx:
    image: <%= ENV["IMAGE_NGINX"] %>
    volumes:
      - '<%= scope.lookupvar('compose::codenvy_folder') -%>/config/nginx/nginx.conf:/etc/nginx/nginx.conf'
      - '<%= scope.lookupvar('compose::codenvy_folder') -%>/logs/nginx/:/var/log/nginx'
    ulimits:
      nproc: 163840
      nofile:
        soft: 163840
        hard: 163840
    restart: always

########################
# SOCAT
########################
  socat:
    image: <%= ENV["IMAGE_SOCAT"] %>
    command: -d -d TCP-L:2375,fork UNIX:/var/run/docker.sock
    volumes:
      - '/var/run/docker.sock:/var/run/docker.sock'
    ports:
      - '23750:2375'
    ulimits:
      nproc: 163840
      nofile:
        soft: 163840
        hard: 163840
    restart: always

########################
# SWARM
########################
  swarm:
    image: <%= ENV["IMAGE_SWARM"] %>
    volumes:
      - '<%= scope.lookupvar('compose::codenvy_folder') -%>/config/swarm/node_list:/node_list'
    command: manage -H 0.0.0.0:2375 file:///node_list
    links:
      - 'socat:codenvy-socat'
    ulimits:
      nproc: 163840
      nofile:
        soft: 163840
        hard: 163840
    restart: always
    depends_on:
      - rsyslog
    logging:
      driver: syslog
      options:
        syslog-address: "tcp://localhost:5140"
        syslog-facility: "local3"

########################
# DOCKER REGISTRY
########################
  registry:
    image: <%= ENV["IMAGE_REGISTRY"] %>
    volumes:
      - '<%= scope.lookupvar('compose::codenvy_folder') -%>/data/registry:/var/lib/registry'
      - '<%= scope.lookupvar('compose::codenvy_folder') -%>/config/registry/config.yml:/etc/docker/registry/config.yml'
    ports:
      - '5000:5000'
    ulimits:
      nproc: 163840
      nofile:
        soft: 163840
        hard: 163840
    restart: always
    depends_on:
       - rsyslog
    logging:
      driver: syslog
      options:
        syslog-address: "tcp://localhost:5140"
        syslog-facility: "local0"

########################
# POSTGRES
########################
  postgres:
    image: <%= ENV["IMAGE_POSTGRES"] %>
    env_file:
<% if @compose_file_for_containers == true -%>
      - '<%= ENV["CHE_CONTAINER_ROOT"] %>/instance/config/postgres/postgres.env'
<% else -%>
      - '<%= ENV["POSTGRES_ENV_FILE"] %>'
<% end -%>
    volumes:
      - '<%= scope.lookupvar('compose::codenvy_folder') -%>/data/postgres:/var/lib/postgresql/data'
      - '<%= scope.lookupvar('compose::codenvy_folder') -%>/config/postgres/postgresql.conf:/etc/postgresql.conf'
    command: postgres -c config_file=/etc/postgresql.conf
<% if scope.lookupvar('codenvy::env') != 'production' -%>
    ports:
      - '5432:5432'
<% end -%>
    ulimits:
      nproc: 163840
      nofile:
        soft: 163840
        hard: 163840
    restart: always

########################
# CODENVY
########################
  codenvy:
    image: <%= ENV["IMAGE_CODENVY"] %>
    depends_on:
      - haproxy
      - postgres
    env_file:
<% if @compose_file_for_containers == true -%>
      - '<%= ENV["CHE_CONTAINER_ROOT"] %>/instance/config/codenvy/codenvy.env'
<% else -%>
      - '<%= ENV["CODENVY_ENV_FILE"] %>'
<% end -%>
    volumes:
       - '<%= scope.lookupvar('compose::puppet_src_folder') -%>:/puppet-configuration'
       - '<%= scope.lookupvar('compose::codenvy_folder') -%>/logs/codenvy/:/opt/codenvy-data/logs/'
       - '<%= scope.lookupvar('compose::codenvy_folder') -%>/logs/codenvy/che-machines-logs/:/opt/codenvy-data/che-machines-logs/'
       - '<%= scope.lookupvar('compose::codenvy_folder') -%>/data/codenvy/fs/:/opt/codenvy-data/fs/'
       - '<%= scope.lookupvar('compose::codenvy_folder') -%>/data/codenvy/license/:/opt/codenvy-data/license/'
       - '<%= scope.lookupvar('compose::codenvy_folder') -%>/data/codenvy/che-machines/:/opt/codenvy-data/che-machines/'
       - '<%= scope.lookupvar('compose::codenvy_folder') -%>/config/codenvy/conf:/opt/codenvy-data/conf'
       - '<%= scope.lookupvar('compose::codenvy_folder') -%>/config/codenvy/conf/server.xml:/opt/codenvy-tomcat/conf/server.xml'
<% if scope.lookupvar('codenvy::env') != 'production' -%>
       - '<%= scope.lookupvar('compose::codenvy_development_tomcat') -%>:/opt/codenvy-tomcat'
<% end -%>
    links:
      - 'postgres:codenvy-postgres'
      - 'swarm:codenvy-swarm'
<% if scope.lookupvar('compose::env') != 'production' -%>
    ports:
      - '8000:8000'
<% end -%>
    ulimits:
      nproc: 163840
      nofile:
        soft: 163840
        hard: 163840
    restart: always
